# [Integrated Spec File v1.3]
# Now includes infrastructure definitions directly.

infrastructure:
  networks:
    pod-net:
      type: pod
    default:
      bridge: br-virt
      nad_name: br-virt-net
      ipam:
        type: whereabouts
        range: 10.215.100.0/24
        gateway: 10.215.100.1
      dns: [8.8.8.8]
      
    storage:
      bridge: br-storage
      nad_name: br-storage-net
      ipam:
        type: whereabouts
        range: 192.168.10.0/24
        # Storage network usually isolates traffic, no gateway by default
      dns: []

  images:
    ubuntu-22.04:
      url: "http://10.215.1.240/vm-images/ubuntu/ubuntu-22.04.qcow2"
      min_cpu: 1
      min_mem: 1Gi

# Common Configuration
common:
  image: "ubuntu-22.04"
  cpu: 1 # Default from config is 1, but we can be explicit
  memory: 1Gi
  # network: default  <-- Removed generic default, using explicit lists

cloud_init: |
  #cloud-config
  ssh_pwauth: True
  users:
    - name: opasnet-admin
      passwd: "{{ password | hash_password }}"
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEvFiws1NEVfzAShpTwpB1VxiLEiGQ7rLB3kNor2alwUFnTjOb9zQkbqVxCNmWbde4XzkfJqs5n3wIrzukOKomqbBJ1vFMej6I0CJj6JHc3a1WNG4RGs8sWZG/RbcH1Qsp5Rwzj38gppuARlonHZnVyfBsIdJSYtTmEmeO/szLK1K+vSsO8kzkveV7lXEEI3kXOUpK3X0SJS5dPK0lPCedvlFVGPjQvlA8n4g1OFhSOe/tprx47Rl/E0/oeZte5LUZkJkru9AMW9l2MGv2mgV8/xZCwoL1QVACMBC14VkS/Ac3blICMTD39MilQ3d8YLFaYusom5xyikY/65oT1YSKKYPSfxj5nNdhYsoFVAtjcCLYI6KJGhwroKND0l7ThxmF6lNCBUtkJnTrMczk0nSnFEGj/+3RCFRRHWoyauMGQeArNrYjSgS5SYMszsPPOuYLsH79aRsmXf2cJ3E1sS21d5BR5NbO57lENB3b02EuIeZ4znPXhvKUBqNOlljd6oc= core@bastion.chk-ocp.skt.local
      groups: [wheel]
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash
    
    - name: dev-user
      passwd: "{{ dev_password | hash_password }}"
      groups: [wheel]
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash

  write_files:
    - path: /etc/netplan/02-static.yaml
      content: |
        network:
          version: 2
          ethernets:
            {% for iface in interfaces %}
            {% if iface.type != 'pod' and iface.ipam.addresses %}
            # Dynamic Interface Config (Prioritize explicit name, else default to enpXs0)
            {% set if_name = iface.interface_name | default("enp" ~ (loop.index0 + 1) ~ "s0") %}
            {{ if_name }}:
              dhcp4: no
              addresses: [{{ iface.ipam.addresses[0].address }}]
              nameservers:
                addresses: [8.8.8.8]
              
              {% if iface.custom_routes %}
              # Custom Routes from Instance Data
              routes:
                {% for r in iface.custom_routes %}
                - to: {{ r.to }}
                  via: {{ r.via }}
                {% endfor %}
              {% elif iface.ipam.gateway %}
              routes:
                - to: 0.0.0.0/0
                  via: {{ iface.ipam.gateway }}
              {% elif loop.index0 == 1 %}
              # Default Gateway Assumption on first secondary nic
              routes:
                - to: 0.0.0.0/0
                  via: 10.215.100.1
              {% endif %}
            {% endif %}
            {% endfor %}

  runcmd:
    - echo 'PasswordAuthentication yes' > /etc/ssh/sshd_config.d/99-force-pw.conf
    - systemctl restart ssh
    - netplan apply



# Explicit Instances Definition (Multi-NIC Supported)
instances:
  - name: web-01
    interfaces:
      - network: default
        ip: 10.215.100.101

  - name: web-02
    interfaces:
      - network: default
        ip: 10.215.100.102
        # Example: Override routes just for this VM
        custom_routes:
          - to: 10.200.0.0/16
            via: 10.215.100.254
            
      - network: storage
        ip: 192.168.10.50
        interface_name: eth1 # Example: Explicit naming override