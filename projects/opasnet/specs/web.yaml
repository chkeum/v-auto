# [Integrated Spec File v1.1]
# Now includes infrastructure definitions directly.

infrastructure:
  networks:
    pod-net:
      type: pod
    default:
      bridge: br-virt
      nad_name: br-virt-net
      ipam:
        type: whereabouts
        range: 10.215.100.0/24
        gateway: 10.215.100.1
      dns: [8.8.8.8]

  images:
    ubuntu-22.04:
      url: "http://10.215.1.240/vm-images/ubuntu/ubuntu-22.04.qcow2"
      min_cpu: 1
      min_mem: 1Gi

# Common Configuration
common:
  image: "ubuntu-22.04"
  cpu: 1 # Default from config is 1, but we can be explicit
  memory: 1Gi
  network: default # Was implictly using the default network


cloud_init: |
  #cloud-config
  ssh_pwauth: True
  users:
    - name: opasnet-admin
      passwd: "{{ password | hash_password }}"
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEvFiws1NEVfzAShpTwpB1VxiLEiGQ7rLB3kNor2alwUFnTjOb9zQkbqVxCNmWbde4XzkfJqs5n3wIrzukOKomqbBJ1vFMej6I0CJj6JHc3a1WNG4RGs8sWZG/RbcH1Qsp5Rwzj38gppuARlonHZnVyfBsIdJSYtTmEmeO/szLK1K+vSsO8kzkveV7lXEEI3kXOUpK3X0SJS5dPK0lPCedvlFVGPjQvlA8n4g1OFhSOe/tprx47Rl/E0/oeZte5LUZkJkru9AMW9l2MGv2mgV8/xZCwoL1QVACMBC14VkS/Ac3blICMTD39MilQ3d8YLFaYusom5xyikY/65oT1YSKKYPSfxj5nNdhYsoFVAtjcCLYI6KJGhwroKND0l7ThxmF6lNCBUtkJnTrMczk0nSnFEGj/+3RCFRRHWoyauMGQeArNrYjSgS5SYMszsPPOuYLsH79aRsmXf2cJ3E1sS21d5BR5NbO57lENB3b02EuIeZ4znPXhvKUBqNOlljd6oc= core@bastion.chk-ocp.skt.local
      groups: [wheel]
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash
    
    - name: dev-user
      passwd: "{{ dev_password | hash_password }}"
      groups: [wheel]
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash

  write_files:
    - path: /etc/netplan/02-static.yaml
      content: |
        network:
          version: 2
          ethernets:
            {{ interface_name }}:
              dhcp4: no
              addresses: [{{ static_ip }}]
              nameservers:
                addresses: [8.8.8.8]

  runcmd:
    - echo 'PasswordAuthentication yes' > /etc/ssh/sshd_config.d/99-force-pw.conf
    - systemctl restart ssh
    - netplan apply



# Explicit Instances Definition
instances:
  - name: web-01
    ip: 10.215.100.101
  - name: web-02
    ip: 10.215.100.102