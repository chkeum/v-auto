# Opasnet Web Server Spec
# Defines Infrastructure (L2/Bridged) and Instances

infrastructure:
  networks:
    pod-net:
      type: pod
    default:
      bridge: br-virt
      nad_name: br-virt-net
      ipam:
        type: whereabouts
        range: 10.215.100.0/24
        gateway: 10.215.100.1
      dns: [8.8.8.8]
      
    storage:
      bridge: br-storage
      nad_name: br-storage-net
      ipam:
        type: whereabouts
        range: 192.168.10.0/24
        # Storage network usually isolates traffic, no gateway by default
      dns: []

  images:
    ubuntu-22.04:
      url: "http://10.215.1.240/vm-images/ubuntu/ubuntu-22.04.qcow2"
      min_cpu: 1
      min_mem: 1Gi

# Common Configuration
common:
  image: "ubuntu-22.04"
  cpu: 1
  memory: 1Gi

cloud_init: |
  #cloud-config
  ssh_pwauth: True
  users:
    - name: admin
      passwd: "{{ admin_password | hash_password }}"
      groups: [wheel]
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash
    
    - name: suer
      passwd: "{{ suser_password | hash_password }}"
      groups: [wheel]
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash

  write_files:
    - path: /etc/netplan/02-static.yaml
      content: |
        {% if network_config %}
        {{ network_config | to_yaml }}
        {% endif %}

  runcmd:
    - echo 'PasswordAuthentication yes' > /etc/ssh/sshd_config.d/99-force-pw.conf
    - systemctl restart ssh
    - netplan apply



# Explicit Instances Definition (Multi-NIC Supported)
instances:
  - name: web-01
    # 1. KubeVirt Attachment
    interfaces:
      - network: default
    
    # 2. OS Configuration
    network_config:
      network:
        version: 2
        ethernets:
          enp1s0:
            dhcp4: no
            addresses: [10.215.100.101/24]
            gateway4: 10.215.100.1
                
  - name: web-02
    # 1. KubeVirt Attachment (Which NADs to plug in?)
    interfaces:
      - network: default
      - network: storage
    
    # 2. OS Configuration (Raw Netplan - Full Control)
    network_config:
      network:
        version: 2
        ethernets:
          # Nic 0 (Default Network)
          enp1s0:
            dhcp4: no
            addresses: [10.215.100.102/24]
            routes:
              - to: 10.200.0.0/16
                via: 10.215.100.254
                
          # Nic 1 (Storage Network)
          enp2s0:
            dhcp4: no
            addresses: [192.168.10.50/24]