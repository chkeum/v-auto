# Opasnet Web Server Spec
# Defines Infrastructure (L2/Bridged) and Instances

infrastructure:
  networks:
    pod-net:
      type: pod
    nms:
      type: multus
      bridge: br-virt
      nad_name: br-virt-net
      
    storage:
      bridge: br-storage
      nad_name: br-storage-net

  images:
    ubuntu-22.04:
      url: "http://10.215.1.240/vm-images/ubuntu/ubuntu-22.04.qcow2"
      min_cpu: 1
      min_mem: 1Gi

# Common Configuration
common:
  image: "ubuntu-22.04"
  cpu: 1
  memory: 1Gi
  disk_size: "10Gi"           # 기본 디스크 크기
  storage_class: "local-sc-test" # 필요시 주석 해제 (기본값: Cluster Default)

cloud_init: |
  #cloud-config
  ssh_pwauth: True
  chpasswd:
    list: |
      core:core
      suser:suser
    expire: False

  users:
    - name: core
      lock_passwd: false
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash
    
    - name: suser
      lock_passwd: false
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash

  write_files:
    # 1. Disable Cloud-Init's default network configuration generator to prevent DHCP conflicts
    - path: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
      content: |
        network: {config: disabled}
    
    # 2. Define our static network configuration
    - path: /etc/netplan/02-static.yaml
      owner: root:root
      permissions: '0600'
      content: |
        {{ {'network': network_config} | to_yaml | indent(8) }}

  runcmd:
    - [ sh, -c, "echo 'PasswordAuthentication yes' > /etc/ssh/sshd_config.d/99-force-pw.conf" ]
    - [ systemctl, restart, ssh ]
    - [ rm, -f, /etc/netplan/50-cloud-init.yaml ]
    - [ netplan, apply ]

instances:
  - name: web-01
    cpu: "500m"
    node_selector:
      kubernetes.io/hostname: worker1.chk-ocp.skt.local
    # 1. KubeVirt Attachment
    interfaces:
      - network: nms
    
    # 2. OS Configuration
    network_config:
      version: 2
      ethernets:
        enp1s0:
          dhcp4: no
          addresses: [10.215.100.101/24]
          routes:
            - to: default
              via: 10.215.100.1
          optional: true
                
  - name: web-02
    node_selector:
      kubernetes.io/hostname: worker2.chk-ocp.skt.local
    # 1. KubeVirt Attachment (Which NADs to plug in?)
    interfaces:
      - network: nms
      - network: storage
    
    # 2. OS Configuration (Raw Netplan - Full Control)
    network_config:
      version: 2
      ethernets:
        # Nic 0 (Default Network)
        enp1s0:
          dhcp4: no
          addresses: [10.215.100.102/24]
          routes:
            - to: default
              via: 10.215.100.1
            - to: 10.200.0.0/16
              via: 10.215.100.254
          optional: true
                
        # Nic 1 (Storage Network)
        enp2s0:
          dhcp4: no
          addresses: [192.168.10.50/24]
          optional: true
